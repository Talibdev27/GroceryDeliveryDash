/**
 * Delivery Zone Validation Utility
 * LENIENT VERSION - Prioritizes accepting valid Yunusabad addresses
 * 
 * Philosophy: Better to accept a few borderline addresses than reject valid customers
 */

// Yunusabad district boundary polygon (for reference, but validation is lenient)
const YUNUSABAD_POLYGON: [number, number][] = [
  [41.3950889, 69.2279846],
  [41.3947836, 69.228167],
  [41.3937078, 69.2290949],
  [41.392965, 69.2297868],
  [41.3822471, 69.2374296],
  [41.3780601, 69.2411223],
  [41.3631398, 69.2614767],
  [41.3556523, 69.2696184],
  [41.3550228, 69.2689124],
  [41.3541383, 69.2679201],
  [41.3530112, 69.2667544],
  [41.349368, 69.26288],
  [41.3493661, 69.262878],
  [41.3479286, 69.2613492],
  [41.3478227, 69.2615335],
  [41.347122, 69.2626694],
  [41.3467838, 69.2632262],
  [41.3464468, 69.2637809],
  [41.3460923, 69.2643397],
  [41.3460888, 69.2643452],
  [41.3453187, 69.264068],
  [41.3449005, 69.2636957],
  [41.3448051, 69.2636134],
  [41.3442842, 69.2631494],
  [41.3441994, 69.2630726],
  [41.3441019, 69.2629835],
  [41.3439925, 69.2631763],
  [41.3436707, 69.2637426],
  [41.3435883, 69.2638876],
  [41.3435329, 69.2639853],
  [41.3434983, 69.2640463],
  [41.3434571, 69.2641186],
  [41.3424989, 69.265806],
  [41.3423993, 69.2659814],
  [41.3421464, 69.2664265],
  [41.3419085, 69.2668431],
  [41.3418503, 69.2669477],
  [41.3417981, 69.2670396],
  [41.3417453, 69.2671325],
  [41.341237, 69.2680275],
  [41.340672, 69.2690094],
  [41.3403253, 69.2696432],
  [41.3402953, 69.2696936],
  [41.3401496, 69.2699674],
  [41.3400433, 69.2701971],
  [41.3399987, 69.2702741],
  [41.3399195, 69.2704238],
  [41.3385578, 69.2728176],
  [41.338016, 69.2737611],
  [41.3380006, 69.2737879],
  [41.3379211, 69.2739266],
  [41.3378503, 69.2740501],
  [41.3375867, 69.2745096],
  [41.3373435, 69.2749085],
  [41.3371912, 69.2747867],
  [41.336914, 69.274512],
  [41.3362052, 69.2742116],
  [41.3359824, 69.2741431],
  [41.3350967, 69.2738511],
  [41.3345403, 69.2736007],
  [41.3338077, 69.2730443],
  [41.3335318, 69.2729386],
  [41.333174, 69.2728946],
  [41.3326283, 69.2729156],
  [41.3320805, 69.2731645],
  [41.3314295, 69.2730271],
  [41.3301055, 69.2728745],
  [41.3297984, 69.2726193],
  [41.3297645, 69.2725546],
  [41.329591, 69.2722318],
  [41.329091, 69.2712011],
  [41.3289408, 69.2709539],
  [41.3286388, 69.2708213],
  [41.3280747, 69.2706079],
  [41.3277677, 69.2704253],
  [41.3274713, 69.2702175],
  [41.3270619, 69.2703542],
  [41.3268101, 69.2705872],
  [41.3266613, 69.2707644],
  [41.3264282, 69.2708612],
  [41.3262275, 69.2707998],
  [41.3258384, 69.2707737],
  [41.3252001, 69.2700788],
  [41.3250251, 69.2699317],
  [41.3248746, 69.2698441],
  [41.3234139, 69.269422],
  [41.3233134, 69.2693894],
  [41.323164, 69.2693456],
  [41.3230315, 69.2693025],
  [41.322952, 69.2692211],
  [41.3225779, 69.268842],
  [41.3222512, 69.2684533],
  [41.3218431, 69.2680721],
  [41.3209555, 69.2676713],
  [41.320316, 69.2674329],
  [41.3200668, 69.2673384],
  [41.3197301, 69.2672268],
  [41.319518, 69.267114],
  [41.318925, 69.2669074],
  [41.3182054, 69.2665887],
  [41.3180152, 69.266456],
  [41.3178874, 69.2663326],
  [41.3172722, 69.2657056],
  [41.3169266, 69.2654912],
  [41.316424, 69.2652979],
  [41.3157462, 69.2650834],
  [41.3149797, 69.2647788],
  [41.3138263, 69.2643967],
  [41.3134627, 69.2641714],
  [41.3133296, 69.2639514],
  [41.3131557, 69.2636587],
  [41.3129408, 69.2635062],
  [41.3127233, 69.2634656],
  [41.3125419, 69.2634029],
  [41.3123178, 69.2633081],
  [41.312244, 69.2629599],
  [41.3121688, 69.2624609],
  [41.3121818, 69.2618434],
  [41.3122173, 69.2609688],
  [41.3121022, 69.2606878],
  [41.3117305, 69.2601777],
  [41.3113604, 69.260018],
  [41.3110966, 69.2599707],
  [41.311, 69.2602847],
  [41.3109925, 69.2603965],
  [41.3108602, 69.2624937],
  [41.3107686, 69.2635268],
  [41.3107398, 69.2636888],
  [41.3107175, 69.2638096],
  [41.3106314, 69.2642211],
  [41.3105954, 69.2643922],
  [41.3104999, 69.2646584],
  [41.3104131, 69.2648505],
  [41.3101454, 69.2654961],
  [41.3100633, 69.2656778],
  [41.3100186, 69.2657873],
  [41.3098635, 69.2661742],
  [41.3098184, 69.2662827],
  [41.3094908, 69.2671379],
  [41.3093958, 69.2674266],
  [41.3093539, 69.267583],
  [41.3094547, 69.2676291],
  [41.3097438, 69.2677628],
  [41.3101721, 69.2679642],
  [41.3107741, 69.2682357],
  [41.3105169, 69.2692326],
  [41.3104108, 69.2696455],
  [41.3105919, 69.2697272],
  [41.3122595, 69.2704796],
  [41.3123778, 69.270533],
  [41.3123408, 69.2706719],
  [41.3118487, 69.2725206],
  [41.3115291, 69.2737212],
  [41.3114856, 69.2738845],
  [41.3114443, 69.2740804],
  [41.3111843, 69.2750165],
  [41.3106129, 69.2771308],
  [41.3105654, 69.2772958],
  [41.3105115, 69.2774925],
  [41.3104764, 69.2776178],
  [41.3103087, 69.2782162],
  [41.3101334, 69.2789397],
  [41.3099409, 69.2798514],
  [41.30993, 69.27992],
  [41.3099223, 69.2800023],
  [41.3099141, 69.2801081],
  [41.3099136, 69.2801493],
  [41.309913, 69.2801887],
  [41.3099163, 69.2802784],
  [41.3099219, 69.2803663],
  [41.3099258, 69.2804048],
  [41.3099367, 69.2805159],
  [41.3099375, 69.2808335],
  [41.3101374, 69.2810411],
  [41.3101587, 69.281071],
  [41.3101804, 69.2811032],
  [41.3102033, 69.2811333],
  [41.3102107, 69.2811419],
  [41.3102174, 69.28115],
  [41.3105391, 69.2814079],
  [41.3106836, 69.2814747],
  [41.3107883, 69.2815144],
  [41.3108427, 69.281526],
  [41.3108925, 69.2815335],
  [41.3109531, 69.2815442],
  [41.3111945, 69.2815786],
  [41.3113331, 69.2815631],
  [41.3114507, 69.2815415],
  [41.3115219, 69.2815237],
  [41.3115903, 69.2815032],
  [41.3116537, 69.281476],
  [41.3117072, 69.2814456],
  [41.3117432, 69.281423],
  [41.3117794, 69.281397],
  [41.311798, 69.281384],
  [41.3118087, 69.2813777],
  [41.3118224, 69.2813656],
  [41.3118356, 69.2813541],
  [41.3118469, 69.2813414],
  [41.3118774, 69.2813084],
  [41.3119393, 69.2812256],
  [41.3120006, 69.2811344],
  [41.3121477, 69.2809094],
  [41.3123741, 69.2804613],
  [41.3124613, 69.2803206],
  [41.3124792, 69.2802924],
  [41.3124998, 69.2802641],
  [41.3125172, 69.2802427],
  [41.3125462, 69.2802172],
  [41.3125762, 69.2801971],
  [41.3126121, 69.2801805],
  [41.3126479, 69.2801707],
  [41.3126857, 69.2801622],
  [41.3127443, 69.2801527],
  [41.3127732, 69.2801498],
  [41.3128021, 69.2801483],
  [41.3128621, 69.2801519],
  [41.3129618, 69.2801725],
  [41.3135545, 69.2803175],
  [41.3143486, 69.2805118],
  [41.3147828, 69.2806167],
  [41.3148853, 69.2806417],
  [41.3148987, 69.2806449],
  [41.3150712, 69.2806823],
  [41.3150425, 69.2808285],
  [41.3150102, 69.2809458],
  [41.31445, 69.282531],
  [41.3143679, 69.282703],
  [41.3144198, 69.2827493],
  [41.3146453, 69.2829835],
  [41.3151981, 69.2835192],
  [41.3156868, 69.2839119],
  [41.3157048, 69.2839262],
  [41.3157955, 69.2839961],
  [41.3159217, 69.2840909],
  [41.3161011, 69.2842546],
  [41.3167768, 69.2848737],
  [41.3170846, 69.2851556],
  [41.3171435, 69.2852096],
  [41.3173219, 69.2853519],
  [41.3173744, 69.2853983],
  [41.3181192, 69.286062],
  [41.3180665, 69.2867021],
  [41.3180991, 69.2867862],
  [41.3180347, 69.2872338],
  [41.3177735, 69.2894791],
  [41.3177041, 69.2902424],
  [41.3176623, 69.2907011],
  [41.3180728, 69.2913924],
  [41.3182604, 69.2915672],
  [41.3199405, 69.2912944],
  [41.320469, 69.2913816],
  [41.3209318, 69.2914579],
  [41.3226582, 69.2917669],
  [41.3225396, 69.2931084],
  [41.3227248, 69.2930833],
  [41.3230338, 69.2928464],
  [41.3236783, 69.293042],
  [41.324859, 69.2937271],
  [41.3249726, 69.2937359],
  [41.3250329, 69.2942667],
  [41.3255462, 69.2946254],
  [41.3255885, 69.294655],
  [41.3253052, 69.2954316],
  [41.3251224, 69.2963983],
  [41.3251555, 69.2964052],
  [41.3253101, 69.2964796],
  [41.3260993, 69.2978276],
  [41.3268218, 69.2980018],
  [41.3273498, 69.2981054],
  [41.3277376, 69.2980727],
  [41.3277958, 69.2981104],
  [41.3283568, 69.297574],
  [41.3284784, 69.297353],
  [41.3286042, 69.2965749],
  [41.3291199, 69.2963953],
  [41.3293941, 69.2964007],
  [41.3299157, 69.2969668],
  [41.3301606, 69.2972929],
  [41.3304163, 69.2977693],
  [41.3303758, 69.2978927],
  [41.3303113, 69.2979893],
  [41.3301662, 69.2982027],
  [41.3300445, 69.2982864],
  [41.3299433, 69.2984238],
  [41.3298934, 69.2986423],
  [41.3298785, 69.2988072],
  [41.3299221, 69.2990954],
  [41.3300123, 69.2992499],
  [41.3301219, 69.2993014],
  [41.330169, 69.2994311],
  [41.3302004, 69.2995156],
  [41.3303539, 69.2999279],
  [41.3306698, 69.3005717],
  [41.33076, 69.3006661],
  [41.3309816, 69.3007868],
  [41.3311088, 69.3009584],
  [41.3315358, 69.3012144],
  [41.3315934, 69.3015509],
  [41.3316782, 69.3016497],
  [41.3321105, 69.3016045],
  [41.3323203, 69.3013872],
  [41.332369, 69.3012856],
  [41.3329094, 69.3003966],
  [41.3334009, 69.3002335],
  [41.3338265, 69.3004844],
  [41.3346895, 69.3010432],
  [41.3348694, 69.3013625],
  [41.335425, 69.301861],
  [41.3361785, 69.3025369],
  [41.3362895, 69.3036251],
  [41.3369905, 69.3109121],
  [41.3368852, 69.3109439],
  [41.3355261, 69.3113795],
  [41.3350367, 69.3116484],
  [41.3322166, 69.3134745],
  [41.331888, 69.3132253],
  [41.3321631, 69.3138223],
  [41.3322208, 69.3139869],
  [41.33256, 69.3149771],
  [41.3327413, 69.3154838],
  [41.3328335, 69.3156739],
  [41.332939, 69.3158666],
  [41.333154, 69.3162426],
  [41.333292, 69.3164786],
  [41.3336981, 69.3166765],
  [41.3340291, 69.3168417],
  [41.3344053, 69.3170463],
  [41.3348257, 69.317102],
  [41.3350736, 69.3171302],
  [41.3353199, 69.3171459],
  [41.3355025, 69.3170977],
  [41.336083, 69.3167064],
  [41.3361499, 69.3166351],
  [41.3362536, 69.316342],
  [41.3363378, 69.3161348],
  [41.3365239, 69.3159406],
  [41.3367812, 69.315795],
  [41.3370096, 69.3156908],
  [41.3372183, 69.3156573],
  [41.3373947, 69.3155843],
  [41.3385314, 69.3156649],
  [41.3385504, 69.3156734],
  [41.338828, 69.3158613],
  [41.3391061, 69.3161079],
  [41.3391264, 69.3161445],
  [41.3393118, 69.3168623],
  [41.339324, 69.3169078],
  [41.3393517, 69.3169577],
  [41.3393947, 69.3169871],
  [41.3402358, 69.3171617],
  [41.3402659, 69.3171776],
  [41.3402981, 69.317216],
  [41.3405774, 69.3180317],
  [41.3409079, 69.318615],
  [41.3409593, 69.3186619],
  [41.3414705, 69.3189923],
  [41.3417521, 69.3190031],
  [41.3422317, 69.3190059],
  [41.3426611, 69.3190176],
  [41.3431496, 69.3189993],
  [41.3435423, 69.3192584],
  [41.3435864, 69.3192952],
  [41.344745, 69.3208509],
  [41.3448047, 69.3208758],
  [41.3448439, 69.3209307],
  [41.3448769, 69.3210215],
  [41.3449043, 69.3210341],
  [41.345303, 69.3214463],
  [41.3453264, 69.3214627],
  [41.3460549, 69.3218293],
  [41.3469137, 69.3222357],
  [41.3469466, 69.3222521],
  [41.3471731, 69.3224891],
  [41.347209, 69.322539],
  [41.3472534, 69.3226525],
  [41.3472931, 69.322777],
  [41.3473582, 69.3229697],
  [41.3473716, 69.3230181],
  [41.3473549, 69.3238577],
  [41.3473809, 69.3240805],
  [41.3474228, 69.3243969],
  [41.3474402, 69.3245236],
  [41.3475498, 69.3248154],
  [41.3479339, 69.3253594],
  [41.3480775, 69.325439],
  [41.3482138, 69.3254859],
  [41.3484009, 69.3255083],
  [41.3488278, 69.3255619],
  [41.3492093, 69.325605],
  [41.3493681, 69.325644],
  [41.3495189, 69.325688],
  [41.3497342, 69.3257058],
  [41.3499725, 69.3258196],
  [41.3501743, 69.3259301],
  [41.3503563, 69.3259101],
  [41.3505246, 69.3258384],
  [41.3510194, 69.3256645],
  [41.3510551, 69.3256606],
  [41.3512381, 69.3257503],
  [41.3512384, 69.3259528],
  [41.3512338, 69.3273702],
  [41.3512306, 69.3283438],
  [41.35123, 69.3285341],
  [41.3512272, 69.3286015],
  [41.3512223, 69.3292767],
  [41.3512116, 69.3295642],
  [41.3512068, 69.3297517],
  [41.3512036, 69.3299507],
  [41.3511905, 69.3308102],
  [41.3511919, 69.3310019],
  [41.3511765, 69.3318349],
  [41.3511643, 69.3324978],
  [41.3511542, 69.3327986],
  [41.3511099, 69.3330641],
  [41.3510348, 69.3332563],
  [41.3509086, 69.333501],
  [41.3508696, 69.3335766],
  [41.3510058, 69.3337056],
  [41.3518278, 69.3346159],
  [41.3518968, 69.3346923],
  [41.3527597, 69.3357464],
  [41.3529406, 69.3359674],
  [41.352975, 69.3360433],
  [41.3536984, 69.3376779],
  [41.3543267, 69.339058],
  [41.3550317, 69.3405996],
  [41.3553711, 69.3413337],
  [41.3555336, 69.3417667],
  [41.3556274, 69.3420165],
  [41.3557506, 69.3425797],
  [41.3559845, 69.3432856],
  [41.3560466, 69.3439257],
  [41.3595535, 69.3382848],
  [41.3614323, 69.3358251],
  [41.3615509, 69.3356287],
  [41.3685573, 69.3264663],
  [41.3696722, 69.3250625],
  [41.370141, 69.3245941],
  [41.3707697, 69.3241472],
  [41.3734176, 69.3229115],
  [41.3814303, 69.3194419],
  [41.3827565, 69.318838],
  [41.3834026, 69.3183806],
  [41.3838733, 69.3179287],
  [41.3843812, 69.3169862],
  [41.3844641, 69.316717],
  [41.3849995, 69.314979],
  [41.3851372, 69.3117102],
  [41.3847826, 69.308025],
  [41.3843709, 69.3043891],
  [41.3841251, 69.3028285],
  [41.3839883, 69.3018445],
  [41.3839131, 69.3005864],
  [41.3838657, 69.2974286],
  [41.3837792, 69.2906137],
  [41.3837805, 69.2905661],
  [41.3837911, 69.2901714],
  [41.3836711, 69.2898976],
  [41.3836405, 69.2881864],
  [41.3836768, 69.2865978],
  [41.3838007, 69.2850918],
  [41.384199, 69.2835382],
  [41.3845866, 69.2823391],
  [41.38521, 69.2809854],
  [41.3861266, 69.2795378],
  [41.387115, 69.2780614],
  [41.3875597, 69.2773943],
  [41.3954538, 69.2650622],
  [41.3960843, 69.263974],
  [41.397128, 69.2617782],
  [41.3976724, 69.2591671],
  [41.3978629, 69.2577316],
  [41.3979356, 69.2562681],
  [41.3986375, 69.2389591],
  [41.3984766, 69.2358791],
  [41.3981018, 69.2341584],
  [41.3976873, 69.2324638],
  [41.39597, 69.2293563],
  [41.3950889, 69.2279846]
];

// Yunusabad center point for distance calculations
const YUNUSABAD_CENTER: [number, number] = [41.3316, 69.2894]; // Approximate center

// COMPREHENSIVE keyword matching - includes ALL possible variations
const YUNUSABAD_KEYWORDS = [
  // Latin script variations
  'yunusabad',
  'yunusobod', 
  'yunusобод',
  'yunus abad',
  'yunus obod',
  'yunusabod',
  
  // Cyrillic variations
  'юнусабад',
  'юнусобод',
  'юнус абад',
  'юнус обод',
  
  // With administrative terms
  'yunusobod tumani',
  'yunusabad tumani',
  'yunusobod dahasi',
  'yunusabad dahasi',
  'yunusobod district',
  'yunusabad district',
  'юнусобод тумани',
  'юнусабад тумани',
  
  // Common misspellings
  'yunosobod',
  'yunsobod',
  'юносоод',
  
  // Neighborhood/area references within Yunusabad
  'mavze', // 13-mavze, 14-mavze, etc.
  'квартал', // kvartal (neighborhood)
];

/**
 * LENIENT VALIDATION - Primary function
 * Uses multiple fallback methods to accept valid Yunusabad addresses
 */
export function validateDeliveryAddress(
  coordinates?: { lat: number; lng: number } | [number, number] | null,
  addressText?: string,
  subtitleText?: string,
  district?: string
): { isValid: boolean; message: string } {
  
  console.log('=== LENIENT DELIVERY VALIDATION ===');
  console.log('Input:', { coordinates, addressText, subtitleText, district });

  // Combine all text for comprehensive searching
  const allText = [addressText, subtitleText, district]
    .filter(Boolean)
    .join(' ')
    .toLowerCase()
    .trim();
  
  console.log('Combined text:', allText);

  // METHOD 1: KEYWORD MATCHING (Most lenient - highest priority)
  // If address contains ANY Yunusabad keyword, accept it
  for (const keyword of YUNUSABAD_KEYWORDS) {
    if (allText.includes(keyword.toLowerCase())) {
      console.log(`✅ VALID: Keyword match found - "${keyword}"`);
      return {
        isValid: true,
        message: `Address recognized as Yunusabad (keyword: ${keyword})`
      };
    }
  }

  // METHOD 2: COORDINATE-BASED VALIDATION (If coordinates provided)
  if (coordinates) {
    let lat: number, lng: number;
    
    // Extract coordinates
    if (Array.isArray(coordinates)) {
      [lat, lng] = coordinates;
    } else {
      lat = coordinates.lat;
      lng = coordinates.lng;
    }

    // Validate coordinate format
    if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
      console.log(`Coordinates: [${lat}, ${lng}]`);
      
      // Check if coordinates are in reasonable Tashkent range
      const inTashkentRange = (
        lat >= 41.1 && lat <= 41.5 &&  // Very wide latitude range
        lng >= 69.1 && lng <= 69.5      // Very wide longitude range
      );

      if (inTashkentRange) {
        // Calculate distance from Yunusabad center
        const distance = calculateDistance([lat, lng], YUNUSABAD_CENTER);
        console.log(`Distance from Yunusabad center: ${distance.toFixed(2)}km`);
        
        // VERY LENIENT: Accept anything within 15km of center
        // This covers the entire Yunusabad district and some buffer
        if (distance <= 15) {
          console.log('✅ VALID: Within 15km radius of Yunusabad center');
          return {
            isValid: true,
            message: `Within Yunusabad delivery area (${distance.toFixed(1)}km from center)`
          };
        }
        
        // Even if outside 15km, try polygon check as backup
        try {
          const inPolygon = isPointInPolygon([lat, lng], YUNUSABAD_POLYGON);
          if (inPolygon) {
            console.log('✅ VALID: Inside Yunusabad polygon boundary');
            return {
              isValid: true,
              message: 'Coordinates within Yunusabad district boundary'
            };
          }
        } catch (error) {
          console.warn('Polygon check failed:', error);
        }
        
        // If we have Tashkent coordinates but failed other checks,
        // be lenient if we have ANY location data
        if (allText.length > 10) { // Has some address text
          console.log('⚠️ BORDERLINE: Tashkent coordinates with address text - accepting');
          return {
            isValid: true,
            message: 'Address in Tashkent area - delivery available'
          };
        }
      }
    }
  }

  // METHOD 3: PARTIAL TEXT MATCHING
  // Check for partial matches or common patterns
  const partialPatterns = [
    /yunus/i,           // Just "yunus" in the text
    /\d+-mavze/i,       // X-mavze pattern (13-mavze, etc.)
    /tashkent.*district/i, // Any Tashkent district mention
  ];

  for (const pattern of partialPatterns) {
    if (pattern.test(allText)) {
      console.log(`⚠️ PARTIAL MATCH: Pattern "${pattern}" found - accepting with warning`);
      return {
        isValid: true,
        message: 'Address appears to be in Yunusabad area'
      };
    }
  }

  // METHOD 4: FALLBACK - If we have SOME location data, be lenient
  const hasSomeLocationData = (
    (coordinates && !Array.isArray(coordinates) && coordinates.lat !== 0) ||
    (Array.isArray(coordinates) && coordinates[0] !== 0) ||
    (allText.length > 20) // Has substantial address text
  );

  if (hasSomeLocationData) {
    console.log('⚠️ FALLBACK: Has some location data but unclear - accepting cautiously');
    return {
      isValid: true,
      message: 'Delivery area confirmed - please verify address details with customer'
    };
  }

  // ALL METHODS FAILED - Only reject if we're very sure it's outside
  console.log('❌ REJECTED: No Yunusabad indicators found');
  return {
    isValid: false,
    message: "Sorry, we don't deliver to this area yet. We currently only deliver within Yunusabad district. We're working to expand our delivery area soon!"
  };
}

/**
 * Calculate distance between two points using Haversine formula
 */
function calculateDistance(point1: [number, number], point2: [number, number]): number {
  const [lat1, lng1] = point1;
  const [lat2, lng2] = point2;
  const R = 6371; // Earth radius in km
  
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

/**
 * Point-in-polygon check (Ray casting algorithm)
 */
function isPointInPolygon(point: [number, number], polygon: [number, number][]): boolean {
  const [lat, lng] = point;
  let inside = false;

  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const [latI, lngI] = polygon[i];
    const [latJ, lngJ] = polygon[j];

    const intersect = 
      ((lngI > lng) !== (lngJ > lng)) &&
      (lat < (latJ - latI) * (lng - lngI) / (lngJ - lngI) + latI);
    
    if (intersect) inside = !inside;
  }

  return inside;
}

// Legacy/compatibility functions
export function isInDeliveryZone(lat: number, lng: number): boolean {
  const result = validateDeliveryAddress({ lat, lng });
  return result.isValid;
}

export function getDeliveryZonePolygon(): [number, number][] {
  return YUNUSABAD_POLYGON;
}

export function getDeliveryZoneCenter(): [number, number] {
  return YUNUSABAD_CENTER;
}

export function isDeliveryAvailable(district: string): boolean {
  return YUNUSABAD_KEYWORDS.some(keyword => 
    district.toLowerCase().includes(keyword.toLowerCase())
  );
}

export function getDeliveryZoneNames(): string[] {
  return ['Yunusabad', 'Yunusobod', 'Юнусобод'];
}

export function getValidationErrorMessage(result: { isValid: boolean; message: string }): string {
  return result.isValid ? '' : result.message;
}
